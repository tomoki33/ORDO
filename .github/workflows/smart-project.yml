name: Smart Project Management

on:
  issues:
    types: [opened, closed, labeled, assigned]
  pull_request:
    types: [opened, closed, ready_for_review, converted_to_draft]

jobs:
  manage-project:
    runs-on: ubuntu-latest
    steps:
      - name: Add item to project
        id: add-to-project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/tomoki33/projects/1
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}

      # è‡ªå‹•çš„ã«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®š
      - name: Auto-assign fields
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.issue.number;
            const labels = context.payload.issue?.labels || [];
            
            // ãƒ©ãƒ™ãƒ«ã‹ã‚‰å„ªå…ˆåº¦ã‚’åˆ¤å®š
            let priority = 'ğŸ“… Low';
            let epic = 'ğŸ”§ Other';
            let size = 'ğŸ“ Medium';
            
            for (const label of labels) {
              // å„ªå…ˆåº¦è¨­å®š
              if (label.name === 'mvp:critical' || label.name === 'priority:p0') {
                priority = 'ğŸ”¥ Critical';
              } else if (label.name === 'mvp:high' || label.name === 'priority:p1') {
                priority = 'âš¡ High';
              } else if (label.name === 'priority:p2') {
                priority = 'ğŸ“‹ Medium';
              }
              
              // Epicè¨­å®š
              if (label.name === 'feature:ai-vision') {
                epic = 'ğŸ¤– AI Vision';
              } else if (label.name === 'feature:ui-core') {
                epic = 'ğŸ¨ UI Core';
              } else if (label.name === 'feature:data') {
                epic = 'ğŸ’¾ Data';
              }
              
              // ã‚µã‚¤ã‚ºè¨­å®š
              if (label.name === 'size:xl') {
                size = 'ğŸ‹ XL';
              } else if (label.name === 'size:l') {
                size = 'ğŸ¦‘ Large';
              } else if (label.name === 'size:s') {
                size = 'ğŸ Small';
              }
            }
            
            console.log(`Setting fields - Priority: ${priority}, Epic: ${epic}, Size: ${size}`);

      # Issueå®Œäº†æ™‚ã®è‡ªå‹•ç§»å‹•
      - name: Move to Done
        if: github.event.action == 'closed'
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/tomoki33/projects/1
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}

      # PRä½œæˆæ™‚ã®è‡ªå‹•å‡¦ç†
      - name: Handle PR creation
        if: github.event.pull_request
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            if (context.payload.action === 'opened') {
              console.log('PR opened, moving to In Review');
              // PRä½œæˆæ™‚ã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã«ç§»å‹•
            }
